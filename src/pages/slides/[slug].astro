---
import { getCollection } from "astro:content";
import { remark } from "remark";
import { visit } from "unist-util-visit";
import { getImage } from "astro:assets";
const { slug } = Astro.params;

const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/content/classes/**/*.{jpeg,jpg,png,gif}"
);
console.log("Images:", images);

const replaceAstroImages = () => {
  return () => (tree) => {
    visit(tree, "image", (node) => {
      if (node.url.startsWith("http")) {
        // Skip external images
        return;
      } else {
        const imageUrl = node.url;
        console.log(imageUrl, slug);
        const imagePath = `/src/content/classes/${slug}/${imageUrl}`;
        // Async logic cannot be used here directly
        // You may need to pre-process images before remark or refactor this logic
        // For now, just log if image exists
        if (images[imagePath]) {
          // You cannot await here; consider handling this outside of visit
          console.log("Found image:", imagePath);
        }
      }
      node.url = node.url.replace("example.com", "cdn.example.com");
      node.alt += " (updated)";
    });
  };
};

export async function getStaticPaths() {
  const slides = await getCollection("slides");
  return slides.map((slide) => {
    return { params: { slug: slide.id.split("/")[0] } };
  });
}

const pageData = import.meta.glob(`/src/content/classes/*/slides.md`, {
  eager: true,
  query: "?raw",
})[`/src/content/classes/${slug}/slides.md`];

const content = pageData.default;

const processedMd = await remark().use(replaceAstroImages()).process(content);
console.log(processedMd.value);
---

<!-- {JSON.stringify(marpKeys)} -->
<div class="reveal">
  <div class="slides">
    <section data-markdown>
      <textarea data-template set:html={content} />
    </section>
  </div>
</div>
<script>
  import Reveal from "reveal.js";
  import Markdown from "reveal.js/plugin/markdown/markdown.esm.js";
  let deck = new Reveal({
    plugins: [Markdown],
    transition: "convex",
    slideNumber: true,
  });
  deck.initialize();
</script>
<link rel="stylesheet" href="/node_modules/reveal.js/dist/reveal.css" />
<link rel="stylesheet" href="/node_modules/reveal.js/dist/theme/night.css" />
<style>
  textarea {
    display: none;
  }
</style>
